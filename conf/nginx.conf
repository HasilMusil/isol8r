# nginx configuration for ISOL8R Sandtrap

# user ctfuser;
worker_processes auto;
pid /tmp/nginx.pid;
events {
    worker_connections 1024;
}
http {
    include       /app/conf/mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    client_body_temp_path /app/tmp/client_body_temp;
    proxy_temp_path /app/tmp/proxy_temp;
    fastcgi_temp_path /app/tmp/fastcgi_temp;
    uwsgi_temp_path /app/tmp/uwsgi_temp;
    scgi_temp_path /app/tmp/scgi_temp;
    keepalive_timeout 15;
    server_tokens off;
    client_max_body_size 5m;
    gzip off;
    add_header X-Sarcasm-Level "elevated" always;
    log_format main '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent"';
    access_log /app/logs/nginx.access.log main;
    error_log  /app/logs/nginx.error.log warn;
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_name _;
        charset utf-8;
        error_page 500 502 503 504 =418 /teapot;
        location = /teapot {
            default_type text/plain;
            return 418 "I'm a teapot. I can't brew coffee. But maybe I can give you the second piece: 'hazmat'. Give a \"message\" to admin.";
        }
        location /static/ {
            if ($uri ~ "\.\.") {
                return 403;
            }
            alias /app/static/;
            try_files $uri $uri/ =404;
            autoindex off;
            add_header Cache-Control "no-store" always;
        }
        location / {
            include /app/conf/uwsgi_params;
            uwsgi_param SCRIPT_NAME "";
            uwsgi_pass unix:/tmp/uwsgi.sock;
            proxy_read_timeout 20s;
            uwsgi_read_timeout 20s;
            add_header Cache-Control "no-store" always;
        }
    }
}
